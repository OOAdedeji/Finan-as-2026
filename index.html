<!DOCTYPE html>
<html lang="pt-pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Financeiro 50/30/20</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; color: #1e293b; }
        .card { background: white; border-radius: 12px; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.05); transition: all 0.2s ease; }
        
        /* Estilos de Edição */
        .editable-text { border: 1px solid transparent; padding: 2px 4px; border-radius: 4px; transition: all 0.2s; cursor: pointer; }
        .editable-text:hover { background-color: #f1f5f9; border-color: #cbd5e1; }
        .editable-text:focus { outline: none; background-color: white; border-color: #3b82f6; box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1); }
        
        .input-val { border: 1px solid transparent; width: 100px; text-align: right; font-weight: 700; color: #1e40af; background: #eff6ff; border-radius: 6px; padding: 4px 8px; }
        .input-val:focus { outline: none; background: white; border-color: #3b82f6; }
        
        .input-desc { border: none; width: 100%; color: #64748b; background: transparent; font-size: 0.85rem; padding: 4px; }
        .input-desc:focus { outline: none; color: #1e293b; }

        .btn-add { color: rgba(255,255,255,0.8); transition: all 0.2s; cursor: pointer; }
        .btn-add:hover { color: white; transform: scale(1.1); }
        
        .btn-del { color: #fecaca; opacity: 0; transition: all 0.2s; cursor: pointer; padding: 0 8px; font-weight: bold; }
        tr:hover .btn-del { opacity: 1; color: #ef4444; }

        #save-indicator { position: fixed; bottom: 20px; right: 20px; padding: 10px 20px; background: #1e293b; color: white; border-radius: 50px; font-size: 12px; display: none; opacity: 0; transition: opacity 0.3s; z-index: 50; }
        
        select { appearance: none; background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e"); background-repeat: no-repeat; background-position: right 0.5rem center; background-size: 1em; }

        /* Cores de Categoria */
        .bg-cat-0 { background-color: #475569; } .text-cat-0 { color: #475569; } .bg-cat-0-light { background-color: #f8fafc; }
        .bg-cat-1 { background-color: #16a34a; } .text-cat-1 { color: #16a34a; } .bg-cat-1-light { background-color: #f0fdf4; }
        .bg-cat-2 { background-color: #eab308; } .text-cat-2 { color: #eab308; } .bg-cat-2-light { background-color: #fefce8; }
        .bg-cat-3 { background-color: #ea580c; } .text-cat-3 { color: #ea580c; } .bg-cat-3-light { background-color: #fff7ed; }

        @media print {
            @page { size: auto; margin: 10mm; }
            body { background: white !important; padding: 0 !important; margin: 0 !important; }
            .no-print { display: none !important; }
            .card { box-shadow: none !important; border: 1px solid #e2e8f0 !important; break-inside: avoid; }
            .max-w-6xl { max-width: 100% !important; width: 100% !important; margin: 0 !important; }
            .input-val { background: transparent !important; color: black !important; border: none !important; width: auto !important; }
            .show-print-inline { display: inline-block !important; }
            .show-print-block { display: block !important; }
        }
    </style>
</head>
<body class="p-4 md:p-8">
    <div id="save-indicator">Alterações guardadas!</div>

    <div class="max-w-6xl mx-auto">
        <!-- Cabeçalho -->
        <div class="flex flex-col md:flex-row justify-between items-start md:items-end mb-8 gap-6">
            <div class="w-full md:w-auto">
                <div class="flex flex-wrap items-center gap-2 mb-4 no-print">
                    <select id="select-mes" class="bg-white border border-slate-200 rounded-lg px-3 py-1 text-sm font-semibold text-slate-600 focus:outline-none focus:ring-2 focus:ring-blue-500 cursor-pointer pr-8"></select>
                    <select id="select-ano" class="bg-white border border-slate-200 rounded-lg px-3 py-1 text-sm font-semibold text-slate-600 focus:outline-none focus:ring-2 focus:ring-blue-500 cursor-pointer pr-8"></select>
                    
                    <div class="flex gap-2 ml-auto md:ml-4">
                        <button onclick="triggerPrint()" title="Exportar PDF" class="p-2 hover:bg-slate-100 rounded-lg text-blue-600 transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z" /></svg>
                        </button>
                        <button onclick="exportData()" title="Backup JSON" class="p-2 hover:bg-slate-100 rounded-lg text-slate-500 transition-colors border-l pl-4">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>
                        </button>
                        <button onclick="document.getElementById('import-file').click()" title="Restaurar JSON" class="p-2 hover:bg-slate-100 rounded-lg text-slate-500 transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" /></svg>
                        </button>
                        <input type="file" id="import-file" class="hidden" accept=".json" onchange="importData(this)">
                    </div>
                </div>
                
                <h1 contenteditable="true" class="editable-text text-4xl font-bold text-slate-800" id="display-titulo">Meu Orçamento</h1>
                <div class="flex items-center gap-2 ml-1">
                    <p class="text-slate-500 no-print">Gestão Financeira Inteligente</p>
                    <span id="periodo-badge" class="hidden show-print-inline bg-slate-100 text-slate-600 px-2 py-1 rounded text-xs font-bold uppercase"></span>
                </div>
            </div>
            
            <div class="bg-blue-600 p-5 rounded-2xl shadow-lg shadow-blue-200 min-w-[240px] text-white text-right">
                <div class="text-xs font-bold text-blue-200 uppercase tracking-widest mb-1">Saldo Final</div>
                <div id="saldo-total" class="text-3xl font-black">R$ 0,00</div>
            </div>
        </div>

        <!-- Gráficos -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-10">
            <div class="card p-6 flex flex-col items-center justify-center">
                <h3 class="text-xs font-bold text-slate-400 uppercase mb-4 text-center">Distribuição Real</h3>
                <div class="relative w-full max-w-[160px]"><canvas id="chartRosca"></canvas></div>
            </div>
            <div class="card p-6 flex flex-col">
                <h3 class="text-xs font-bold text-slate-400 uppercase mb-4 text-center">Ideal (50/30/20) vs Real</h3>
                <div class="flex-1 min-h-[140px]"><canvas id="chartBarras"></canvas></div>
            </div>
            <div class="card p-6 bg-slate-900 text-white">
                <h3 class="text-xs font-bold text-slate-500 uppercase mb-6">Resumo de Fluxo</h3>
                <div class="space-y-4">
                    <div class="flex justify-between"><span class="text-slate-400 text-sm">Entradas</span><span id="resumo-entradas" class="font-bold text-emerald-400">R$ 0,00</span></div>
                    <div class="flex justify-between"><span class="text-slate-400 text-sm">Saídas Totais</span><span id="resumo-gastos" class="font-bold text-rose-400">R$ 0,00</span></div>
                    <div class="pt-4 border-t border-slate-800">
                        <div class="flex justify-between mb-2"><span class="text-slate-500 text-xs italic">Comprometimento</span><span id="resumo-percentual" class="text-xs font-bold text-blue-400">0%</span></div>
                        <div class="w-full bg-slate-800 h-2 rounded-full overflow-hidden">
                            <div id="progress-bar" class="bg-blue-500 h-full transition-all duration-700" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tabelas de Categorias -->
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6" id="tables-container"></div>
        
        <p class="hidden show-print-block mt-8 text-[10px] text-slate-400 text-center italic border-t pt-4">
            Relatório gerado em <span id="print-data-emissao"></span>. Dados armazenados localmente.
        </p>
    </div>

    <script>
        let chartRosca, chartBarras;
        
        const defaultData = {
            titulo: "Meu Orçamento",
            categorias: [
                { id: 'table-entradas', label: 'Receitas', items: [{ desc: 'Salário', val: 0 }] },
                { id: 'table-necessidades', label: 'Fixos (50%)', items: [{ desc: 'Habitação', val: 0 }] },
                { id: 'table-desejos', label: 'Variáveis (30%)', items: [{ desc: 'Lazer', val: 0 }] },
                { id: 'table-economias', label: 'Investir (20%)', items: [{ desc: 'Poupanca', val: 0 }] }
            ]
        };

        function getStorageKey() {
            const mes = document.getElementById('select-mes').value;
            const ano = document.getElementById('select-ano').value;
            return `finance_app_v1_${ano}_${mes}`;
        }

        function triggerPrint() {
            const m = document.getElementById('select-mes');
            const mesText = m.options[m.selectedIndex].text;
            const anoVal = document.getElementById('select-ano').value;
            document.getElementById('periodo-badge').innerText = `${mesText} / ${anoVal}`;
            document.getElementById('print-data-emissao').innerText = new Date().toLocaleString('pt-PT');
            window.print();
        }

        function formatCurrency(value) {
            return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(value);
        }

        function exportData() {
            const allData = {};
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && key.startsWith('finance_app_v1_')) {
                    allData[key] = JSON.parse(localStorage.getItem(key));
                }
            }
            const blob = new Blob([JSON.stringify(allData, null, 2)], { type: 'application/json' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `backup_financeiro_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
        }

        function importData(input) {
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const imported = JSON.parse(e.target.result);
                    Object.keys(imported).forEach(key => localStorage.setItem(key, JSON.stringify(imported[key])));
                    loadData();
                    alert("Dados importados com sucesso!");
                } catch(err) { alert("Ficheiro inválido."); }
            };
            reader.readAsText(input.files[0]);
        }

        function saveData() {
            const data = {
                titulo: document.getElementById('display-titulo').innerText,
                categorias: []
            };
            document.querySelectorAll('.label-cat').forEach(catLabel => {
                const tableId = catLabel.closest('.card').querySelector('tbody').id;
                const items = [];
                document.querySelectorAll(`#${tableId} tr`).forEach(row => {
                    const desc = row.querySelector('.input-desc')?.value;
                    const val = parseFloat(row.querySelector('.input-val')?.value) || 0;
                    if(desc !== undefined) items.push({ desc, val });
                });
                data.categorias.push({ id: tableId, label: catLabel.innerText, items });
            });
            localStorage.setItem(getStorageKey(), JSON.stringify(data));
            showIndicator();
        }

        function loadData() {
            const saved = localStorage.getItem(getStorageKey());
            const data = saved ? JSON.parse(saved) : defaultData;
            document.getElementById('display-titulo').innerText = data.titulo || "Meu Orçamento";
            renderTables(data.categorias);
        }

        function showIndicator() {
            const ind = document.getElementById('save-indicator');
            ind.style.display = 'block';
            ind.style.opacity = '1';
            setTimeout(() => { 
                ind.style.opacity = '0'; 
                setTimeout(() => ind.style.display = 'none', 300); 
            }, 800);
        }

        function renderTables(categorias) {
            const container = document.getElementById('tables-container');
            container.innerHTML = '';
            categorias.forEach((cat, index) => {
                const card = document.createElement('div');
                card.className = `card overflow-hidden flex flex-col ring-1 ring-slate-100`;
                card.innerHTML = `
                    <div class="bg-cat-${index} px-4 py-3 flex justify-between items-center">
                        <span contenteditable="true" class="editable-text text-white font-bold text-xs uppercase tracking-widest label-cat">${cat.label}</span>
                        <button onclick="addRow('${cat.id}')" class="btn-add no-print">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3"><path d="M12 4v16m8-8H4" /></svg>
                        </button>
                    </div>
                    <div class="p-3 flex-1"><table class="w-full text-xs border-collapse"><tbody id="${cat.id}">
                        ${cat.items.map(i => createRowHTML(i.desc, i.val)).join('')}
                    </tbody></table></div>
                    <div class="bg-cat-${index}-light p-3 text-right border-t">
                        <div class="text-[10px] text-cat-${index} uppercase font-bold">Total</div>
                        <div id="total-${cat.id}" class="font-black text-slate-800 text-sm">R$ 0,00</div>
                    </div>`;
                container.appendChild(card);
            });
            calculate();
        }

        function createRowHTML(desc, val) {
            return `<tr class="group border-b border-slate-50 last:border-0">
                <td class="no-print"><button onclick="removeRow(this)" class="btn-del">×</button></td>
                <td class="w-full"><input class="input-desc" value="${desc}" placeholder="Descrição..."></td>
                <td><input class="input-val val" type="number" step="0.01" value="${val}" onfocus="this.select()"></td>
            </tr>`;
        }

        function addRow(id) {
            const tb = document.getElementById(id);
            const tr = document.createElement('tr');
            tr.className = "group border-b border-slate-50 last:border-0";
            tr.innerHTML = createRowHTML("Novo Item", 0);
            tb.appendChild(tr);
            calculate(); saveData();
        }

        function removeRow(btn) { btn.closest('tr').remove(); calculate(); saveData(); }

        function calculate() {
            const getSum = (id) => {
                let s = 0;
                document.querySelectorAll(`#${id} .val`).forEach(i => s += parseFloat(i.value) || 0);
                return s;
            };
            
            const e = getSum('table-entradas');
            const n = getSum('table-necessidades');
            const d = getSum('table-desejos');
            const i = getSum('table-economias');
            const totalG = n + d + i;
            const saldo = e - totalG;

            // Atualizar Totais nas Tabelas
            const ids = ['table-entradas','table-necessidades','table-desejos','table-economias'];
            const vals = [e, n, d, i];
            ids.forEach((id, idx) => {
                const el = document.getElementById(`total-${id}`);
                if(el) el.innerText = formatCurrency(vals[idx]);
            });

            // Atualizar Cabeçalho e Resumo
            document.getElementById('resumo-entradas').innerText = formatCurrency(e);
            document.getElementById('resumo-gastos').innerText = formatCurrency(totalG);
            document.getElementById('saldo-total').innerText = formatCurrency(saldo);
            
            const perc = e > 0 ? (totalG / e) * 100 : 0;
            document.getElementById('resumo-percentual').innerText = Math.round(perc) + '%';
            document.getElementById('progress-bar').style.width = Math.min(perc, 100) + '%';
            document.getElementById('progress-bar').className = perc > 100 ? 'bg-rose-500 h-full' : 'bg-blue-500 h-full';

            // Atualizar Gráficos
            if(chartRosca) {
                chartRosca.data.datasets[0].data = [n, d, i];
                chartRosca.update('none');
                
                chartBarras.data.datasets[0].data = [e*0.5, e*0.3, e*0.2];
                chartBarras.data.datasets[1].data = [n, d, i];
                chartBarras.update('none');
            }
        }

        function initCharts() {
            chartRosca = new Chart(document.getElementById('chartRosca'), {
                type: 'doughnut',
                data: { 
                    labels: ['Fixos', 'Desejos', 'Investimento'], 
                    datasets: [{ 
                        data: [0,0,0], 
                        backgroundColor: ['#16a34a', '#eab308', '#ea580c'], 
                        borderWidth: 0,
                        hoverOffset: 4
                    }] 
                },
                options: { cutout: '75%', plugins: { legend: { display: false } }, animation: false }
            });
            
            chartBarras = new Chart(document.getElementById('chartBarras'), {
                type: 'bar',
                data: { 
                    labels: ['50% Fixos', '30% Desejos', '20% Inv.'], 
                    datasets: [
                        { label: 'Ideal', data: [0,0,0], backgroundColor: '#f1f5f9', borderRadius: 6 },
                        { label: 'Real', data: [0,0,0], backgroundColor: ['#16a34a', '#eab308', '#ea580c'], borderRadius: 6 }
                    ]
                },
                options: { 
                    maintainAspectRatio: false, 
                    scales: { y: { display: false }, x: { grid: { display: false }, ticks: { font: { size: 9 } } } }, 
                    plugins: { legend: { display: false } }, 
                    animation: false 
                }
            });
        }

        // Configuração Inicial
        window.onload = () => {
            const meses = ["Janeiro","Fevereiro","Março","Abril","Maio","Junho","Julho","Agosto","Setembro","Outubro","Novembro","Dezembro"];
            const mS = document.getElementById('select-mes');
            const aS = document.getElementById('select-ano');
            const now = new Date();

            meses.forEach((m, idx) => {
                const opt = document.createElement('option');
                opt.value = String(idx + 1).padStart(2, '0');
                opt.innerText = m;
                mS.appendChild(opt);
            });
            
            for(let a = 2024; a <= 2030; a++) {
                const opt = document.createElement('option');
                opt.value = a; opt.innerText = a;
                aS.appendChild(opt);
            }

            mS.value = String(now.getMonth() + 1).padStart(2, '0');
            aS.value = now.getFullYear();

            initCharts();
            loadData();

            // Listeners de Eventos
            mS.addEventListener('change', loadData);
            aS.addEventListener('change', loadData);
            
            document.addEventListener('input', (e) => {
                if (e.target.classList.contains('input-val') || 
                    e.target.classList.contains('input-desc') || 
                    e.target.id === 'display-titulo' || 
                    e.target.classList.contains('label-cat')) {
                    calculate();
                    saveData();
                }
            });
        };
    </script>
</body>
</html>
